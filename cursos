import { Injectable, NotFoundException } from '@nestjs/common';
import { PrismaService } from 'src/prisma/prisma.service';

@Injectable()
export class UsuarioService {
  constructor(private prisma: PrismaService) {}

  async iniciarSesion(e_mail: string) {
    const usuario = await this.prisma.$queryRaw<any[]>`
      SELECT id_emp, nombre, publico, e_mail 
      FROM gescur.emp_nomina 
      WHERE TRIM(e_mail) = TRIM(${e_mail})`;
  
    if (usuario.length === 0) {
      throw new NotFoundException('Usuario no encontrado');
    }
  
    const usuarioEncontrado = usuario[0];

    // Consultar el rol del usuario
    const roles = await this.prisma.rol_usuario.findMany({
      where: { usuario: usuarioEncontrado.e_mail },
      select: { rol: true },
    });

    // Verifica si tiene rol 1 (admin) o rol 2 (profesor)
    const esAdmin = roles.some(r => r.rol === 1);
    const esProfesor = roles.some(r => r.rol === 2);

    return {
      id_emp: usuarioEncontrado.id_emp,
      nombre: usuarioEncontrado.nombre,
      publico: usuarioEncontrado.publico,
      e_mail: usuarioEncontrado.e_mail,
      esAdmin,
      esProfesor,
    };
  }
}